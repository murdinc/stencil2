{{define "content"}}
<div class="content-header">
    {{if eq .ReplyStatus "success"}}
    <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px 16px; border-radius: 4px; margin-bottom: 16px;">
        <strong>✓ Reply sent successfully!</strong> The customer has been emailed.
    </div>
    {{else if eq .ReplyStatus "error"}}
    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 12px 16px; border-radius: 4px; margin-bottom: 16px;">
        <strong>✗ Failed to send reply.</strong>
        <br><small>Error: {{.ReplyError}}</small>
        <br><small>Your message has been preserved below. Please fix the issue and try again.</small>
    </div>
    {{end}}

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2>Message from {{.Message.Name}}</h2>
            <p><a href="/site/{{.Website.ID}}/messages" style="color: #667eea; text-decoration: none;">&larr; Back to messages</a></p>
        </div>
        <div style="display: flex; gap: 8px;">
            <form action="/site/{{.Website.ID}}/messages/{{.Message.ID}}/toggle-read" method="POST">
                {{if eq .Message.Status "read"}}
                <button type="submit" class="btn" style="background: #718096;">Mark as Unread</button>
                {{else}}
                <button type="submit" class="btn btn-success">Mark as Read</button>
                {{end}}
            </form>
            <form action="/site/{{.Website.ID}}/messages/{{.Message.ID}}/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this message and all replies? This cannot be undone.');">
                <button type="submit" class="btn" style="background: #e53e3e; border-color: #e53e3e; color: white;">Delete Message</button>
            </form>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
    <!-- Message Thread -->
    <div>
        <!-- Original Message -->
        <div class="card" style="margin-bottom: 20px; {{if eq .Message.Status "unread"}}border-left: 4px solid #f56565;{{end}}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div>
                    <h3 style="margin-bottom: 8px;">{{.Message.Name}}</h3>
                    <p style="color: #718096; font-size: 14px; margin-bottom: 4px;">
                        <a href="mailto:{{.Message.Email}}" style="color: #667eea;">{{.Message.Email}}</a>
                    </p>
                    <p style="color: #a0aec0; font-size: 13px;">
                        {{.Message.CreatedAt.Format "Monday, January 2, 2006 at 3:04 PM"}}
                    </p>
                </div>
                {{if eq .Message.Status "unread"}}
                <span style="background: #f56565; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">UNREAD</span>
                {{end}}
            </div>
            <div style="padding: 16px; background: #f7fafc; border-radius: 6px; white-space: pre-wrap; line-height: 1.6;">{{.Message.Message}}</div>
        </div>

        <!-- Replies -->
        {{range .Message.Replies}}
        <div class="card" style="margin-bottom: 20px; margin-left: 40px; border-left: 4px solid #667eea;">
            <div style="margin-bottom: 12px;">
                <strong style="color: #667eea;">You replied</strong>
                <span style="color: #a0aec0; font-size: 13px; margin-left: 8px;">
                    {{.SentAt.Format "Jan 2, 2006 3:04 PM"}}
                </span>
            </div>
            <div style="padding: 16px; background: #f0f4ff; border-radius: 6px; white-space: pre-wrap; line-height: 1.6;">{{.ReplyText}}</div>
        </div>
        {{end}}

        <!-- Reply Form -->
        <div class="card">
            <h3>Send Reply</h3>
            <form action="/site/{{.Website.ID}}/messages/{{.Message.ID}}/reply" method="POST">
                <div class="form-group">
                    <label for="reply_text">Your Reply</label>
                    <textarea id="reply_text" name="reply_text" required placeholder="Type your reply here...">{{.PreservedReply}}</textarea>
                </div>
                <button type="submit" class="btn btn-success">Send Reply (will email {{.Message.Email}})</button>
            </form>
        </div>
    </div>

    <!-- Sidebar -->
    <div>
        <div class="card">
            <h3>Message Info</h3>
            <table style="width: 100%;">
                <tr>
                    <td><strong>Name:</strong></td>
                    <td>{{.Message.Name}}</td>
                </tr>
                <tr>
                    <td><strong>Email:</strong></td>
                    <td><a href="mailto:{{.Message.Email}}" style="color: #667eea; word-break: break-all;">{{.Message.Email}}</a></td>
                </tr>
                <tr>
                    <td><strong>Status:</strong></td>
                    <td>
                        {{if eq .Message.Status "read"}}
                        <span style="color: #48bb78;">Read</span>
                        {{else}}
                        <span style="color: #f56565;">Unread</span>
                        {{end}}
                    </td>
                </tr>
                <tr>
                    <td><strong>Received:</strong></td>
                    <td>{{.Message.CreatedAt.Format "Jan 2, 2006"}}</td>
                </tr>
                <tr>
                    <td><strong>Replies:</strong></td>
                    <td>{{len .Message.Replies}}</td>
                </tr>
            </table>
        </div>

        {{if .Customer}}
        <div class="card">
            <h3>Customer Profile</h3>
            <table style="width: 100%;">
                <tr>
                    <td><strong>Name:</strong></td>
                    <td>{{.Customer.FirstName}} {{.Customer.LastName}}</td>
                </tr>
                <tr>
                    <td><strong>Orders:</strong></td>
                    <td><a href="/site/{{$.Website.ID}}/customers/{{.Customer.ID}}" style="color: #667eea;">{{.Customer.OrderCount}} order{{if ne .Customer.OrderCount 1}}s{{end}}</a></td>
                </tr>
                <tr>
                    <td><strong>Total Spent:</strong></td>
                    <td>${{printf "%.2f" .Customer.TotalSpent}}</td>
                </tr>
                {{if .Customer.FirstOrder}}
                <tr>
                    <td><strong>First Order:</strong></td>
                    <td>{{.Customer.FirstOrder.Format "Jan 2, 2006"}}</td>
                </tr>
                {{end}}
                {{if .Customer.LastOrder}}
                <tr>
                    <td><strong>Last Order:</strong></td>
                    <td>{{.Customer.LastOrder.Format "Jan 2, 2006"}}</td>
                </tr>
                {{end}}
            </table>
            <a href="/site/{{$.Website.ID}}/customers/{{.Customer.ID}}" class="btn" style="width: 100%; text-align: center; margin-top: 12px; display: block; text-decoration: none;">View Customer Profile</a>
        </div>
        {{end}}
    </div>
</div>
{{end}}
