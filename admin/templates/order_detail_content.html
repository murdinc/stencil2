{{define "content"}}
<div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h2>Order {{.Order.OrderNumber}}</h2>
        <p>View order details for {{.Website.SiteName}}</p>
    </div>
    <a href="/site/{{.Website.ID}}/orders/{{.Order.ID}}/packing-slip" target="_blank" class="btn" style="background: #667eea; color: white; text-decoration: none;">
        Print Packing Slip
    </a>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
    <!-- Order Items -->
    <div class="card">
        <h3>Order Items</h3>
        <table>
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Variant</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {{range .Order.Items}}
                <tr>
                    <td><strong>{{.ProductName}}</strong></td>
                    <td>{{if .VariantTitle}}{{.VariantTitle}}{{else}}-{{end}}</td>
                    <td>${{printf "%.2f" .Price}}</td>
                    <td>{{.Quantity}}</td>
                    <td>${{printf "%.2f" .Total}}</td>
                </tr>
                {{end}}
            </tbody>
        </table>

        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e1e8ed;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Subtotal:</span>
                <span>${{printf "%.2f" .Order.Subtotal}}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Tax:</span>
                <span>${{printf "%.2f" .Order.Tax}}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Shipping:</span>
                <span>${{printf "%.2f" .Order.ShippingCost}}</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 600; padding-top: 10px; border-top: 2px solid #667eea;">
                <span>Total:</span>
                <span>${{printf "%.2f" .Order.Total}}</span>
            </div>
        </div>
    </div>

    <!-- Order Info -->
    <div>
        <div class="card" style="margin-bottom: 20px;">
            <h3>Order Status</h3>
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-weight: 600; margin-bottom: 4px; color: #555;">Payment Status</label>
                <div style="padding: 8px 12px; border-radius: 4px; display: inline-block;
                    {{if eq .Order.PaymentStatus "paid"}}background: #e6ffed; color: #48bb78; border: 1px solid #48bb78;
                    {{else if eq .Order.PaymentStatus "pending"}}background: #fff4e6; color: #f59e0b; border: 1px solid #f59e0b;
                    {{else}}background: #fee; color: #f56565; border: 1px solid #f56565;{{end}}">
                    {{.Order.PaymentStatus}}
                </div>
            </div>
            <div>
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #555;">Fulfillment Status</label>
                {{if eq .Order.PaymentStatus "paid"}}
                <form action="/site/{{.Website.ID}}/orders/{{.Order.ID}}/fulfillment" method="POST" style="display: flex; gap: 8px; align-items: center;">
                    <select name="fulfillment_status" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="unfulfilled" {{if eq .Order.FulfillmentStatus "unfulfilled"}}selected{{end}}>Unfulfilled</option>
                        <option value="processing" {{if eq .Order.FulfillmentStatus "processing"}}selected{{end}}>Processing</option>
                        <option value="fulfilled" {{if eq .Order.FulfillmentStatus "fulfilled"}}selected{{end}}>Fulfilled</option>
                        <option value="shipped" {{if eq .Order.FulfillmentStatus "shipped"}}selected{{end}}>Shipped</option>
                    </select>
                    <button type="submit" class="btn btn-sm">Update</button>
                </form>
                {{else}}
                <div style="padding: 8px 12px; border-radius: 4px; display: inline-block;
                    {{if eq .Order.FulfillmentStatus "fulfilled"}}background: #e6ffed; color: #48bb78; border: 1px solid #48bb78;
                    {{else if eq .Order.FulfillmentStatus "unfulfilled"}}background: #fff4e6; color: #f59e0b; border: 1px solid #f59e0b;
                    {{else}}background: #e8eef5; color: #4a5568; border: 1px solid #d1d5db;{{end}}">
                    {{.Order.FulfillmentStatus}}
                </div>
                <p style="font-size: 12px; color: #999; margin-top: 8px;">Payment must be completed before fulfillment can be updated</p>
                {{end}}
            </div>
        </div>

        {{if eq .Order.PaymentStatus "paid"}}
        <div class="card" style="margin-bottom: 20px;">
            <h3>Shipping Label</h3>
            {{if .Order.TrackingNumber}}
            <!-- Label has been purchased -->
            <div style="padding: 12px; background: #e6ffed; border: 1px solid #48bb78; border-radius: 4px; margin-bottom: 12px;">
                <p style="margin: 0; color: #48bb78; font-weight: 600;">✓ Label Purchased</p>
            </div>
            <div style="margin-bottom: 8px;">
                <label style="display: block; font-weight: 600; margin-bottom: 4px; color: #555;">Carrier</label>
                <p style="margin: 0;">{{.Order.ShippingCarrier}}</p>
            </div>
            <div style="margin-bottom: 8px;">
                <label style="display: block; font-weight: 600; margin-bottom: 4px; color: #555;">Tracking Number</label>
                <p style="margin: 0; font-family: monospace;">{{.Order.TrackingNumber}}</p>
            </div>
            {{if .Order.ShippingLabelCost}}
            <div style="margin-bottom: 8px;">
                <label style="display: block; font-weight: 600; margin-bottom: 4px; color: #555;">Label Cost</label>
                <p style="margin: 0;">${{printf "%.2f" .Order.ShippingLabelCost}}</p>
            </div>
            {{end}}
            {{if .Order.ShippingLabelURL}}
            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                <a href="{{.Order.ShippingLabelURL}}" target="_blank" class="btn btn-sm">View Label</a>
                <button onclick="printLabel('{{.Order.ShippingLabelURL}}')" class="btn btn-sm btn-success">Print Label</button>
                <a href="{{.Order.ShippingLabelURL}}" download class="btn btn-sm" style="background: #4299e1;">Download Label</a>
            </div>
            <script>
                function printLabel(url) {
                    const printWindow = window.open(url, '_blank');
                    printWindow.addEventListener('load', function() {
                        printWindow.print();
                    });
                }
            </script>
            {{end}}
            {{else}}
            <!-- No label yet, show purchase form -->
            <p style="font-size: 14px; color: #666; margin-bottom: 16px;">Enter package dimensions to get shipping rates</p>

            <div id="dimensionsForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #555;">Length (in)</label>
                        <input type="number" id="length" step="0.1" min="0.1" placeholder="12" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #555;">Width (in)</label>
                        <input type="number" id="width" step="0.1" min="0.1" placeholder="9" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #555;">Height (in)</label>
                        <input type="number" id="height" step="0.1" min="0.1" placeholder="6" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #555;">Weight (lbs)</label>
                        <input type="number" id="weight" step="0.1" min="0.1" placeholder="2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
                <button onclick="getRates()" class="btn btn-sm" style="width: 100%;">Get Shipping Rates</button>
            </div>

            <div id="ratesResult" style="display: none; margin-top: 16px;">
                <h4 style="margin-bottom: 12px;">Available Rates</h4>
                <div id="ratesList"></div>
            </div>

            <div id="errorMessage" style="display: none; padding: 12px; background: #fee; color: #f56565; border: 1px solid #f56565; border-radius: 4px; margin-top: 12px;"></div>

            <script>
            function getRates() {
                const length = document.getElementById('length').value;
                const width = document.getElementById('width').value;
                const height = document.getElementById('height').value;
                const weight = document.getElementById('weight').value;

                if (!length || !width || !height || !weight) {
                    showError('Please fill in all dimensions');
                    return;
                }

                // Hide previous results
                document.getElementById('ratesResult').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';

                // Make API call to get rates
                const formData = new FormData();
                formData.append('length', length);
                formData.append('width', width);
                formData.append('height', height);
                formData.append('weight', weight);

                fetch('/site/{{.Website.ID}}/orders/{{.Order.ID}}/shipping/rates', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayRates(data.rates);
                    } else {
                        showError(data.error || 'Failed to get rates');
                    }
                })
                .catch(error => {
                    showError('Error: ' + error.message);
                });
            }

            function displayRates(rates) {
                const ratesList = document.getElementById('ratesList');
                ratesList.innerHTML = '';

                // Sort rates by price (cheapest first)
                rates.sort((a, b) => parseFloat(a.amount) - parseFloat(b.amount));

                rates.forEach(rate => {
                    const rateDiv = document.createElement('div');
                    rateDiv.style.cssText = 'border: 1px solid #ddd; border-radius: 4px; padding: 12px; margin-bottom: 8px; cursor: pointer;';
                    rateDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;">${rate.provider} - ${rate.servicelevel.name}</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${rate.duration_terms || (rate.estimated_days > 0 ? `Estimated ${rate.estimated_days} day${rate.estimated_days !== 1 ? 's' : ''}` : 'Standard delivery')}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: 600;">$${rate.amount}</div>
                                <button onclick="purchaseLabel('${rate.object_id}')" class="btn btn-sm" style="margin-top: 4px;">Purchase</button>
                            </div>
                        </div>
                    `;
                    ratesList.appendChild(rateDiv);
                });

                document.getElementById('ratesResult').style.display = 'block';
            }

            function purchaseLabel(rateId) {
                if (!confirm('Are you sure you want to purchase this shipping label?')) {
                    return;
                }

                const formData = new FormData();
                formData.append('rate_id', rateId);

                fetch('/site/{{.Website.ID}}/orders/{{.Order.ID}}/shipping/purchase', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to show the label info
                        window.location.reload();
                    } else {
                        showError(data.error || 'Failed to purchase label');
                    }
                })
                .catch(error => {
                    showError('Error: ' + error.message);
                });
            }

            function showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            </script>
            {{end}}
        </div>
        {{end}}

        <div class="card" style="margin-bottom: 20px;">
            <h3>Customer</h3>
            <p><strong>{{.Order.CustomerName}}</strong></p>
            <p>{{.Order.CustomerEmail}}</p>
        </div>

        <div class="card">
            <h3>Shipping Address</h3>
            <p>{{.Order.ShippingAddressLine1}}</p>
            {{if .Order.ShippingAddressLine2}}
            <p>{{.Order.ShippingAddressLine2}}</p>
            {{end}}
            <p>{{.Order.ShippingCity}}, {{.Order.ShippingState}} {{.Order.ShippingZip}}</p>
            <p>{{.Order.ShippingCountry}}</p>
        </div>
    </div>
</div>

<a href="/site/{{.Website.ID}}/orders" class="btn">← Back to Orders</a>
{{end}}
