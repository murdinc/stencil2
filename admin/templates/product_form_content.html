{{define "content"}}
<div class="content-header">
    <h2>{{.FormTitle}}</h2>
    <p>{{if .Product}}Edit product{{else}}Create a new product{{end}} for {{.Website.SiteName}}</p>
</div>

<div class="card">
    <form method="POST" action="{{.Action}}" enctype="multipart/form-data">
        <div class="form-group">
            <label>Name:</label>
            <input type="text" name="name" value="{{if .Product}}{{.Product.Name}}{{end}}" required>
        </div>
        <div class="form-group">
            <label>Slug:</label>
            <input type="text" name="slug" value="{{if .Product}}{{.Product.Slug}}{{end}}" required>
        </div>
        <div class="form-group">
            <label>Description:</label>
            <textarea name="description">{{if .Product}}{{.Product.Description}}{{end}}</textarea>
        </div>
        <div class="form-group">
            <label>Price:</label>
            <input type="number" name="price" step="0.01" value="{{if .Product}}{{.Product.Price}}{{end}}" required>
            <small style="display: block; margin-top: 4px; color: #666;">Base price for product. Variants can add/subtract from this price.</small>
        </div>
        <div class="form-group">
            <label>Compare At Price:</label>
            <input type="number" name="compareAtPrice" step="0.01" value="{{if .Product}}{{.Product.CompareAtPrice}}{{end}}">
        </div>
        <div class="form-group">
            <label>SKU:</label>
            <input type="text" name="sku" value="{{if .Product}}{{.Product.SKU}}{{end}}">
        </div>
        <div class="form-group">
            <label>Inventory Quantity:</label>
            <input type="number" name="inventoryQuantity" value="{{if .Product}}{{.Product.InventoryQuantity}}{{end}}">
            <small style="display: block; margin-top: 4px; color: #666;">Overall inventory. Variants can use this or have their own inventory.</small>
        </div>
        <div class="form-group">
            <label>Inventory Policy:</label>
            <select name="inventoryPolicy">
                <option value="deny" {{if .Product}}{{if eq .Product.InventoryPolicy "deny"}}selected{{end}}{{end}}>Deny</option>
                <option value="continue" {{if .Product}}{{if eq .Product.InventoryPolicy "continue"}}selected{{end}}{{end}}>Continue</option>
            </select>
        </div>

        {{if .Product}}
        <div class="form-group">
            <label>Product Variants:</label>
            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px; background: #f7fafc;">
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    Manage different variations of this product (e.g., sizes, colors). Variants override the base price and inventory above.
                </p>

                {{if .Product.Variants}}
                <div id="variants-list" style="margin-bottom: 15px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 8px; text-align: center; width: 60px;">Order</th>
                                <th style="padding: 8px; text-align: left;">Title</th>
                                <th style="padding: 8px; text-align: right;">Price Modifier</th>
                                <th style="padding: 8px; text-align: right;">Inventory</th>
                                <th style="padding: 8px; text-align: left;">SKU</th>
                                <th style="padding: 8px; text-align: center; width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range $index, $variant := .Product.Variants}}
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px; text-align: center; white-space: nowrap;">
                                    {{if gt $index 0}}
                                        <form style="display:inline; margin:0;">
                                            <button type="submit" formmethod="POST" formaction="/site/{{$.Website.ID}}/products/{{$.Product.ID}}/variants/{{$variant.ID}}/reorder/up" class="btn btn-sm btn-success" style="padding:2px 8px; margin-right:2px;">↑</button>
                                        </form>
                                    {{else}}
                                        <button disabled class="btn btn-sm" style="padding:2px 8px;background:#ddd;color:#999;cursor:not-allowed; margin-right:2px;">↑</button>
                                    {{end}}
                                    {{$variantCount := len $.Product.Variants}}
                                    {{$nextIndex := add $index 1}}
                                    {{if lt $nextIndex $variantCount}}
                                        <form style="display:inline; margin:0;">
                                            <button type="submit" formmethod="POST" formaction="/site/{{$.Website.ID}}/products/{{$.Product.ID}}/variants/{{$variant.ID}}/reorder/down" class="btn btn-sm btn-success" style="padding:2px 8px;">↓</button>
                                        </form>
                                    {{else}}
                                        <button disabled class="btn btn-sm" style="padding:2px 8px;background:#ddd;color:#999;cursor:not-allowed;">↓</button>
                                    {{end}}
                                </td>
                                <td style="padding: 8px;"><strong>{{$variant.Title}}</strong></td>
                                <td style="padding: 8px; text-align: right;">{{if ne $variant.PriceModifier 0.0}}{{if gt $variant.PriceModifier 0.0}}+{{end}}${{printf "%.2f" $variant.PriceModifier}}{{else}}-{{end}}</td>
                                <td style="padding: 8px; text-align: right;">{{$variant.InventoryQuantity}}</td>
                                <td style="padding: 8px;">{{$variant.SKU}}</td>
                                <td style="padding: 8px; text-align: center;">
                                    <button type="button" onclick="editVariant({{$variant.ID}})" class="btn">Edit</button>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                {{else}}
                <p style="color: #999; font-style: italic; margin-bottom: 15px;">No variants yet.</p>
                {{end}}

                <button type="button" onclick="window.location.href='/site/{{$.Website.ID}}/products/{{.Product.ID}}/variants/new'" class="btn btn-success" style="font-size: 13px;">
                    + Add Variant
                </button>
            </div>
        </div>
        {{end}}

        <div class="form-group">
            <label>Status:</label>
            <select name="status">
                <option value="draft" {{if .Product}}{{if eq .Product.Status "draft"}}selected{{end}}{{end}}>Draft</option>
                <option value="published" {{if .Product}}{{if eq .Product.Status "published"}}selected{{end}}{{end}}>Published</option>
                <option value="archived" {{if .Product}}{{if eq .Product.Status "archived"}}selected{{end}}{{end}}>Archived</option>
            </select>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" name="featured" {{if .Product}}{{if .Product.Featured}}checked{{end}}{{end}}>
                Featured
            </label>
        </div>
        <div class="form-group">
            <label>Collections:</label>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                {{if .Collections}}
                    {{range $collection := .Collections}}
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" name="collections[]" value="{{$collection.ID}}"
                            {{if $.Product}}{{range $.ProductCollections}}{{if eq .ID $collection.ID}}checked{{end}}{{end}}{{end}}>
                        {{$collection.Name}}
                    </label>
                    {{end}}
                {{else}}
                    <p style="color: #7f8c8d; margin: 0;">No collections available. <a href="/site/{{.Website.ID}}/collections">Create one</a>.</p>
                {{end}}
            </div>
        </div>

        <div class="form-group">
            <label>Product Images:</label>
            <div style="border: 1px solid #ddd; border-radius: 4px; padding: 15px;">
                {{if $.Product}}
                <div id="current-images" style="margin-bottom: 15px;">
                    <p style="font-size: 12px; color: #27ae60; margin: 0 0 10px 0;">Current images (drag to reorder):</p>
                    <div id="images-grid" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        {{range .ProductImages}}
                        <div class="image-item" draggable="true" data-id="{{.ID}}" style="position: relative; border: 1px solid #ddd; border-radius: 4px; padding: 5px; cursor: move; background: white;">
                            <img src="{{.URL}}" alt="{{.AltText}}" style="width: 150px; height: 150px; object-fit: cover; border-radius: 4px; pointer-events: none;">
                            <label style="display: block; margin-top: 5px; font-size: 11px; cursor: pointer;">
                                <input type="checkbox" name="remove_images[]" value="{{.ID}}" style="width: auto; margin-right: 3px;">
                                Remove
                            </label>
                        </div>
                        {{end}}
                    </div>
                </div>
                {{end}}

                <div>
                    <label>Upload new images:</label>
                    <input type="file" name="product_images" accept="image/*" multiple style="width: 100%; margin-bottom: 10px;">
                    <div style="margin-bottom: 10px;">
                        <label style="font-size: 12px;">Alt text for new images (optional):</label>
                        <input type="text" name="new_images_alt" placeholder="Describe the images" style="width: 100%; padding: 6px;">
                    </div>
                    <div>
                        <label style="font-size: 12px;">Credit for new images (optional):</label>
                        <input type="text" name="new_images_credit" placeholder="Photo by..." style="width: 100%; padding: 6px;">
                    </div>
                    <p style="font-size: 12px; color: #7f8c8d; margin: 10px 0 0 0;">You can upload multiple images at once. They will be added in the order selected.</p>
                </div>
            </div>
        </div>

        <script>
        // Drag and drop functionality for image reordering
        const imagesGrid = document.getElementById('images-grid');
        if (imagesGrid) {
            let draggedItem = null;

            imagesGrid.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('image-item')) {
                    draggedItem = e.target;
                    e.target.style.opacity = '0.5';
                }
            });

            imagesGrid.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('image-item')) {
                    e.target.style.opacity = '1';
                }
            });

            imagesGrid.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(imagesGrid, e.clientX, e.clientY);
                if (afterElement == null) {
                    imagesGrid.appendChild(draggedItem);
                } else {
                    imagesGrid.insertBefore(draggedItem, afterElement);
                }
            });

            imagesGrid.addEventListener('drop', function(e) {
                e.preventDefault();
                // Save new order to server
                saveImageOrder();
            });

            function getDragAfterElement(container, x, y) {
                const draggableElements = [...container.querySelectorAll('.image-item:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offsetX = x - box.left - box.width / 2;
                    const offsetY = y - box.top - box.height / 2;
                    const offset = Math.sqrt(offsetX * offsetX + offsetY * offsetY);

                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function saveImageOrder() {
                const imageItems = imagesGrid.querySelectorAll('.image-item');
                const imageIds = Array.from(imageItems).map(item => parseInt(item.dataset.id));

                // Send AJAX request to save new order
                fetch('/site/{{.Website.ID}}/products/{{if .Product}}{{.Product.ID}}{{end}}/images/reorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ imageIds: imageIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Failed to save image order: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error saving image order:', error);
                    alert('Failed to save image order');
                });
            }
        }

        // Variant management
        function editVariant(variantId) {
            window.location.href = '/site/{{.Website.ID}}/products/{{if .Product}}{{.Product.ID}}{{end}}/variants/' + variantId + '/edit';
        }
        </script>

        <button type="submit" class="btn">Save Product</button>
        <a href="/site/{{.Website.ID}}/products" class="btn" style="background: #6c757d; margin-left: 10px;">Cancel</a>
    </form>
</div>
{{end}}
