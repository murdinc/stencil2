{{define "content"}}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <div>
            <h2>{{.Website.SiteName}}</h2>
            <p>Site overview and quick stats</p>
        </div>
        <div id="active-users-badge" style="background: #48bb78; color: white; padding: 10px 16px; border-radius: 6px; text-align: center; min-width: 100px; box-shadow: 0 1px 4px rgba(72, 187, 120, 0.2);">
            <div style="font-size: 24px; font-weight: 700; line-height: 1;">{{.ActiveUsers}}</div>
            <div style="font-size: 11px; margin-top: 3px; opacity: 0.9;">Active Users</div>
            <div style="font-size: 10px; margin-top: 2px; opacity: 0.7;">Live now</div>
        </div>
    </div>
    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        <a href="/site/{{.Website.ID}}/articles/new" class="btn btn-success" style="padding: 6px 12px; font-size: 13px;">+ Article</a>
        <a href="/site/{{.Website.ID}}/products/new" class="btn btn-success" style="padding: 6px 12px; font-size: 13px;">+ Product</a>
        <a href="/site/{{.Website.ID}}/analytics" class="btn" style="padding: 6px 12px; font-size: 13px;">Analytics</a>
        <a href="/site/{{.Website.ID}}/settings" class="btn" style="padding: 6px 12px; font-size: 13px;">Settings</a>
    </div>
</div>

<!-- Recent Activity & Messages -->
<div style="margin-bottom: 16px;">
    <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">Recent Activity</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                <div>
                    <div style="font-size: 32px; font-weight: 700; line-height: 1; color: white;">{{.Stats.OrdersToday}}</div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 4px;">Orders Today</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 24px; font-weight: 700; color: white;">${{printf "%.0f" .Stats.RevenueToday}}</div>
                    <div style="font-size: 10px; color: rgba(255,255,255,0.8);">revenue</div>
                </div>
            </div>
            <div style="font-size: 10px; color: rgba(255,255,255,0.7); padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
                {{.Stats.OrdersThisWeek}} orders (7d) • ${{printf "%.0f" .Stats.RevenueThisWeek}} &nbsp;|&nbsp; {{.Stats.OrdersThisMonth}} orders (30d) • ${{printf "%.0f" .Stats.RevenueThisMonth}}
            </div>
        </div>
        {{if gt .Stats.TotalMessages 0}}
        <div class="stat-card" style="background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); color: white; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                <div>
                    <div style="font-size: 32px; font-weight: 700; line-height: 1; color: white;">{{.Stats.UnreadMessages}}</div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 4px;">Unread Messages</div>
                </div>
            </div>
            <div style="font-size: 10px; color: rgba(255,255,255,0.7); padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
                {{.Stats.TotalMessages}} total messages &nbsp;|&nbsp; <a href="/site/{{.Website.ID}}/messages" style="color: white; text-decoration: underline;">View inbox</a>
            </div>
        </div>
        {{end}}
    </div>
</div>

<!-- Analytics Stats -->
<div style="margin-bottom: 16px;">
    <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">Analytics</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
        <div class="stat-card" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
                <div>
                    <div style="font-size: 28px; font-weight: 700; line-height: 1; color: white;">{{.Stats.PageviewsToday}}</div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 4px;">Pageviews Today</div>
                </div>
            </div>
            <div style="font-size: 10px; color: rgba(255,255,255,0.7); padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.2);">
                {{.Stats.UniqueVisitorsToday}} unique today &nbsp;|&nbsp; {{.Stats.PageviewsThisWeek}} (7d) &nbsp;|&nbsp; {{.Stats.PageviewsThisMonth}} (30d) &nbsp;|&nbsp; {{.Stats.TotalPageviews}} total
            </div>
        </div>
    </div>
</div>

<!-- Traffic Trend (Last 7 Days) -->
<div class="card" style="margin-bottom: 16px;">
    <h3 style="margin-bottom: 16px;">7-Day Traffic & Revenue</h3>
    <div style="position: relative; height: 200px;">
        <canvas id="overviewChart"></canvas>
    </div>
</div>

<!-- 7-Day Orders & Engagement -->
<div class="card" style="margin-bottom: 16px;">
    <h3 style="margin-bottom: 16px;">7-Day Orders & Engagement</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
            <h4 style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: normal;">Order Count</h4>
            <div style="position: relative; height: 200px;">
                <canvas id="overviewOrdersChart"></canvas>
            </div>
        </div>
        <div>
            <h4 style="font-size: 14px; color: #666; margin-bottom: 10px; font-weight: normal;">Engagement Metrics</h4>
            <div style="position: relative; height: 200px;">
                <canvas id="overviewEngagementChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- E-commerce Stats -->
<div style="margin-bottom: 16px;">
    <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">E-Commerce Overview</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px;">
        <div class="stat-card">
            <div class="stat-value">${{printf "%.0f" .Stats.TotalRevenue}}</div>
            <div class="stat-label">Total Revenue</div>
            <div class="stat-detail">All time</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalOrders}}</div>
            <div class="stat-label">Total Orders</div>
            <div class="stat-detail">All time</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalCustomers}}</div>
            <div class="stat-label">Customers</div>
            <div class="stat-detail">{{.Stats.RepeatCustomers}} repeat customers</div>
        </div>
    </div>
</div>


<!-- Recent Orders -->
{{if .RecentOrders}}
<div class="card" style="margin-bottom: 16px;">
    <h3>Recent Orders</h3>
    <table>
        <thead>
            <tr>
                <th>Order Number</th>
                <th>Customer</th>
                <th>Total</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .RecentOrders}}
            <tr>
                <td><strong>{{.OrderNumber}}</strong></td>
                <td>
                    {{.CustomerName}}<br>
                    <span style="font-size: 12px; color: #718096;">{{.CustomerEmail}}</span>
                </td>
                <td>${{printf "%.2f" .Total}}</td>
                <td>
                    {{if eq .PaymentStatus "paid"}}
                    <span style="color: #48bb78; font-weight: 600;">Paid</span>
                    {{else if eq .PaymentStatus "pending"}}
                    <span style="color: #ed8936; font-weight: 600;">Pending</span>
                    {{else}}
                    <span style="color: #f56565; font-weight: 600;">{{.PaymentStatus}}</span>
                    {{end}}
                </td>
                <td>{{.CreatedAt.Format "Jan 2, 2006 3:04 PM"}}</td>
                <td>
                    <a href="/site/{{$.Website.ID}}/orders/{{.ID}}" class="btn btn-sm">View</a>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>
    <div style="margin-top: 16px;">
        <a href="/site/{{.Website.ID}}/orders" class="btn">View All Orders</a>
    </div>
</div>
{{else}}
<div class="card" style="margin-bottom: 16px;">
    <h3>Recent Orders</h3>
    <div class="empty-state">
        <h3>No Orders Yet</h3>
        <p>Orders will appear here once customers start purchasing.</p>
    </div>
</div>
{{end}}

<!-- Content Stats -->
<div style="margin-bottom: 16px;">
    <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">Content</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalArticles}}</div>
            <div class="stat-label">Total Articles</div>
            <div class="stat-detail">{{.Stats.PublishedArticles}} published, {{.Stats.DraftArticles}} drafts</div>
        </div>
    </div>
</div>

<!-- Marketing Stats -->
{{if gt .Stats.TotalSMSSignups 0}}
<div style="margin-bottom: 16px;">
    <h3 style="margin-bottom: 10px; color: #333; font-size: 16px;">Marketing</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
        <div class="stat-card">
            <div class="stat-value">{{.Stats.TotalSMSSignups}}</div>
            <div class="stat-label">SMS Signups</div>
            <div class="stat-detail">Total subscribers</div>
        </div>
    </div>
</div>
{{end}}

<style>
.stat-card {
    background: white;
    border-radius: 6px;
    padding: 12px 16px;
    border: 1px solid #e1e8ed;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    transition: transform 0.15s, box-shadow 0.15s;
}

.stat-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 4px;
    line-height: 1;
}

.stat-label {
    font-size: 11px;
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 2px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.stat-detail {
    font-size: 11px;
    color: #718096;
}
</style>

<script>
// Auto-refresh active users count every 30 seconds
function updateActiveUsers() {
    fetch(window.location.pathname)
        .then(response => response.text())
        .then(html => {
            // Parse the HTML to extract just the active users count
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newBadge = doc.getElementById('active-users-badge');
            if (newBadge) {
                const currentBadge = document.getElementById('active-users-badge');
                if (currentBadge) {
                    // Smoothly update the badge
                    currentBadge.innerHTML = newBadge.innerHTML;

                    // Add a subtle pulse animation
                    currentBadge.style.transform = 'scale(1.05)';
                    setTimeout(() => {
                        currentBadge.style.transform = 'scale(1)';
                    }, 200);
                }
            }
        })
        .catch(error => {
            console.error('Error updating active users:', error);
        });
}

// Update every 30 seconds
setInterval(updateActiveUsers, 30000);

// Add smooth transition for badge updates
document.getElementById('active-users-badge').style.transition = 'transform 0.2s ease-out';
</script>

<!-- Chart.js for traffic overview -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Parse time series data from server
const timeSeriesData = JSON.parse({{.TimeSeriesJSON}});

if (timeSeriesData && timeSeriesData.length > 0) {
    // Prepare chart data
    const labels = timeSeriesData.map(d => d.date);
    const pageviews = timeSeriesData.map(d => d.pageviews);
    const visitors = timeSeriesData.map(d => d.visitors);
    const revenue = timeSeriesData.map(d => d.revenue);

    // Create gradients
    const ctx = document.getElementById('overviewChart').getContext('2d');
    const pageviewsGradient = ctx.createLinearGradient(0, 0, 0, 200);
    pageviewsGradient.addColorStop(0, 'rgba(37, 99, 235, 0.15)');
    pageviewsGradient.addColorStop(1, 'rgba(37, 99, 235, 0.0)');

    const visitorsGradient = ctx.createLinearGradient(0, 0, 0, 200);
    visitorsGradient.addColorStop(0, 'rgba(72, 187, 120, 0.15)');
    visitorsGradient.addColorStop(1, 'rgba(72, 187, 120, 0.0)');

    const revenueGradient = ctx.createLinearGradient(0, 0, 0, 200);
    revenueGradient.addColorStop(0, 'rgba(245, 158, 11, 0.15)');
    revenueGradient.addColorStop(1, 'rgba(245, 158, 11, 0.0)');

    // Initialize compact chart
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Pageviews',
                data: pageviews,
                borderColor: '#2563eb',
                backgroundColor: pageviewsGradient,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointHoverRadius: 5,
                pointBackgroundColor: '#2563eb',
                pointBorderColor: '#fff',
                pointBorderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Visitors',
                data: visitors,
                borderColor: '#48bb78',
                backgroundColor: visitorsGradient,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointHoverRadius: 5,
                pointBackgroundColor: '#48bb78',
                pointBorderColor: '#fff',
                pointBorderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Revenue',
                data: revenue,
                borderColor: '#f59e0b',
                backgroundColor: revenueGradient,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointHoverRadius: 5,
                pointBackgroundColor: '#f59e0b',
                pointBorderColor: '#fff',
                pointBorderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 11,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#1f2937',
                    titleColor: '#fff',
                    bodyColor: '#d1d5db',
                    borderColor: '#374151',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: true,
                    callbacks: {
                        title: function(context) {
                            const dateStr = context[0].label;
                            const [year, month, day] = dateStr.split('-');
                            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                            return date.toLocaleDateString('en-US', {
                                weekday: 'short',
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        font: {
                            size: 10
                        },
                        color: '#9ca3af'
                    },
                    grid: {
                        color: '#f3f4f6',
                        drawBorder: false
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    ticks: {
                        precision: 2,
                        font: {
                            size: 10
                        },
                        color: '#f59e0b',
                        callback: function(value) {
                            return '$' + value.toFixed(0);
                        }
                    },
                    grid: {
                        drawOnChartArea: false,
                        drawBorder: false
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        font: {
                            size: 10
                        },
                        color: '#9ca3af',
                        callback: function(value, index) {
                            const dateStr = this.getLabelForValue(value);
                            const [year, month, day] = dateStr.split('-');
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            return monthNames[parseInt(month) - 1] + ' ' + parseInt(day);
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Parse engagement data
    const engagementData = JSON.parse({{.EngagementJSON}});

    // Limit to last 7 days only for the overview chart
    const last7Days = engagementData.slice(-7);

    const paidOrders = last7Days.map(d => d.paid_orders);
    const pendingOrders = last7Days.map(d => d.pending_orders);
    const avgPagesPerVisit = last7Days.map(d => d.avg_pages_per_visit);
    const avgTimeOnSite = last7Days.map(d => d.avg_time_on_site);

    // Order Count Chart (compact dashboard version)
    const ordersCtx = document.getElementById('overviewOrdersChart').getContext('2d');

    // Use labels from last 7 days
    const last7DaysLabels = last7Days.map(d => d.date);

    new Chart(ordersCtx, {
        type: 'bar',
        data: {
            labels: last7DaysLabels,
            datasets: [{
                label: 'Paid',
                data: paidOrders,
                backgroundColor: '#10b981',
                borderColor: '#059669',
                borderWidth: 1,
                barPercentage: 0.8,
                categoryPercentage: 0.9
            }, {
                label: 'Pending',
                data: pendingOrders,
                backgroundColor: '#f59e0b',
                borderColor: '#d97706',
                borderWidth: 1,
                barPercentage: 0.8,
                categoryPercentage: 0.9
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 8,
                        font: { size: 9, weight: '500' }
                    }
                },
                tooltip: {
                    backgroundColor: '#1f2937',
                    titleColor: '#fff',
                    bodyColor: '#d1d5db',
                    borderColor: '#374151',
                    borderWidth: 1,
                    padding: 8,
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            const dateStr = context[0].label;
                            const [year, month, day] = dateStr.split('-');
                            const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                            return date.toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric'
                            });
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    stacked: true,
                    ticks: {
                        precision: 0,
                        font: { size: 9 },
                        color: '#9ca3af',
                        stepSize: 1
                    },
                    grid: {
                        color: '#f3f4f6',
                        drawBorder: false
                    }
                },
                x: {
                    stacked: true,
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        font: { size: 9 },
                        color: '#9ca3af',
                        callback: function(value, index) {
                            const dateStr = this.getLabelForValue(value);
                            const [year, month, day] = dateStr.split('-');
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            return monthNames[parseInt(month) - 1] + ' ' + parseInt(day);
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Engagement Metrics Chart (compact dashboard version)
    const engagementCtx = document.getElementById('overviewEngagementChart').getContext('2d');
    new Chart(engagementCtx, {
        type: 'line',
        data: {
            labels: last7DaysLabels,
            datasets: [{
                label: 'Pages/Visit',
                data: avgPagesPerVisit,
                borderColor: '#06b6d4',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointHoverRadius: 5,
                pointBackgroundColor: '#06b6d4',
                pointBorderColor: '#fff',
                pointBorderWidth: 1,
                yAxisID: 'y'
            }, {
                label: 'Time (s)',
                data: avgTimeOnSite,
                borderColor: '#ec4899',
                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 2,
                pointHoverRadius: 5,
                pointBackgroundColor: '#ec4899',
                pointBorderColor: '#fff',
                pointBorderWidth: 1,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 10,
                        font: { size: 9, weight: '500' }
                    }
                },
                tooltip: {
                    backgroundColor: '#1f2937',
                    titleColor: '#fff',
                    bodyColor: '#d1d5db',
                    borderColor: '#374151',
                    borderWidth: 1,
                    padding: 8,
                    callbacks: {
                        title: function(context) {
                            return new Date(context[0].label).toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric'
                            });
                        },
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 1) {
                                    const seconds = Math.floor(context.parsed.y);
                                    const mins = Math.floor(seconds / 60);
                                    const secs = seconds % 60;
                                    label += mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
                                } else {
                                    label += context.parsed.y.toFixed(2);
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    ticks: {
                        precision: 1,
                        font: { size: 9 },
                        color: '#06b6d4'
                    },
                    grid: {
                        color: '#f3f4f6',
                        drawBorder: false
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        font: { size: 9 },
                        color: '#ec4899',
                        callback: function(value) {
                            return value + 's';
                        }
                    },
                    grid: {
                        drawOnChartArea: false,
                        drawBorder: false
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        font: { size: 9 },
                        color: '#9ca3af',
                        callback: function(value, index) {
                            const dateStr = this.getLabelForValue(value);
                            const [year, month, day] = dateStr.split('-');
                            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                            return monthNames[parseInt(month) - 1] + ' ' + parseInt(day);
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}
</script>
{{end}}
